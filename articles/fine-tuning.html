<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Fine-tuning • nixtlar</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Fine-tuning">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">nixtlar</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.6.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/get-started.html">Get Started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/anomaly-detection.html">Anomaly Detection</a></li>
    <li><a class="dropdown-item" href="../articles/azure-quickstart.html">Azure Quickstart</a></li>
    <li><a class="dropdown-item" href="../articles/cross-validation.html">Cross-Validation</a></li>
    <li><a class="dropdown-item" href="../articles/data-requirements.html">Data requirements</a></li>
    <li><a class="dropdown-item" href="../articles/exogenous-variables.html">Exogenous Variables</a></li>
    <li><a class="dropdown-item" href="../articles/fine-tuning.html">Fine-tuning</a></li>
    <li><a class="dropdown-item" href="../articles/historical-forecast.html">Historical Forecast</a></li>
    <li><a class="dropdown-item" href="../articles/long-horizon.html">Long Horizon Forecast</a></li>
    <li><a class="dropdown-item" href="../articles/prediction-intervals.html">Prediction Intervals</a></li>
    <li><a class="dropdown-item" href="../articles/quantiles.html">Quantile Forecasts</a></li>
    <li><a class="dropdown-item" href="../articles/setting-up-your-api-key.html">Setting Up Your API Key</a></li>
    <li><a class="dropdown-item" href="../articles/special-topics.html">Special Topics</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-experiments" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Experiments</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-experiments">
<li><a class="dropdown-item" href="../articles/vn1-forecasting-competition.html">VN1 Competition</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/Nixtla/nixtlar"><span class="fa fa-github"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://docs.nixtla.io/">Nixtla</a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Fine-tuning</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Nixtla/nixtlar/blob/master/vignettes/fine-tuning.Rmd" class="external-link"><code>vignettes/fine-tuning.Rmd</code></a></small>
      <div class="d-none name"><code>fine-tuning.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://nixtla.github.io/nixtlar/">nixtlar</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">1. Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Foundation models, such as TimeGPT, are trained on large and diverse
datasets, enabling them to generate predictions for data not seen during
training. This process, where the model is used directly to solve a
forecasting task, is known as <strong>zero-shot learning</strong>. It is
also possible, however, to further train the model on a new dataset,
starting from its pre-trained parameters. This process, called
<strong>fine-tuning</strong>, aims to improve the accuracy of
predictions by tailoring the model to the specific characteristics of
the new data.</p>
<p>By default, TimeGPT employs a zero-shot approach for faster
computation. However, several options are available for fine-tuning
TimeGPT to your data. While fine-tuning increases the total execution
time, it can improve forecast accuracy.</p>
<p>In this vignette, we explain how to fine-tune TimeGPT using the
<code>nixtlar</code> package. It assumes you have already set up your
API key. If you haven’t done this, please read the <a href="https://nixtla.github.io/nixtlar/articles/get-started.html">Get
Started</a> vignette first.</p>
</div>
<div class="section level2">
<h2 id="fine-tuning-parameters">2. Fine-tuning parameters<a class="anchor" aria-label="anchor" href="#fine-tuning-parameters"></a>
</h2>
<p>The parameters that can be used for fine-tuning TimeGPT via
<code>nixtlar</code> are:</p>
<ul>
<li><p><code>finetune_steps</code> (int): The number of training
iterations on the input data. Forecasts are then produced using the
updated model.</p></li>
<li><p><code>finetune_depth</code> (int, from 1 to 5): A value
controlling how many parameters of TimeGPT are fine-tuned on your
dataset. When set to 1, only a few parameters are fine-tuned, while
setting it to 5 fine-tunes all parameters. <a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;It is not possible to select the specific parameters
manually.&lt;/p&gt;"><sup>1</sup></a></p></li>
<li>
<p><code>finetune_loss</code> (string, see options): The name of the
loss function used during fine-tuning. Options available are:</p>
<ul>
<li>
<code>default</code>: A proprietary loss function robust to
outliers</li>
<li>
<code>mae</code>: Mean Absolute Error</li>
<li>
<code>mse</code>: Mean Squared Error</li>
<li>
<code>rmse</code>: Root Mean Squared Error</li>
<li>
<code>mape</code>: Mean Absolute Percentage Error</li>
<li>
<code>smape</code>: Symmetric Mean Absolute Percentage Error</li>
</ul>
</li>
</ul>
<p><strong>Note that the <code>finetune_depth</code> and
<code>finetune_loss</code> parameters will only work when
<code>finetune_steps &gt; 0</code>. Otherwise, these parameters will be
ignored.</strong></p>
<p>The fine-tuning parameters are available in the following
<code>nixtlar</code> functions:</p>
<ul>
<li><code>nixtla_client_forecast</code></li>
<li><code>nixtla_client_historic</code></li>
<li><code>nixtla_client_cross_validation</code></li>
</ul>
</div>
<div class="section level2">
<h2 id="example">3. Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h2>
<p>In this section, we will show a simple example where fine-tuning
improves the accuracy of the forecast. We will forecast the last 24
hours of the electricity consumption dataset included in
<code>nixtlar</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">nixtlar</span><span class="fu">::</span><span class="va"><a href="../reference/electricity.html">electricity</a></span></span>
<span></span>
<span><span class="va">train_df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">unique_id</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="fl">24</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">test_df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">unique_id</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_tail</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">24</span><span class="op">)</span> </span></code></pre></div>
<p>After splitting the data into training and test sets, we will
generate a forecast using the zero-shot model of TimeGPT and another two
using <code>finetune_steps</code> and <code>finetune_depth</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fc_zeroshot</span> <span class="op">&lt;-</span> <span class="fu">nixtlar</span><span class="fu">::</span><span class="fu"><a href="../reference/nixtla_client_forecast.html">nixtla_client_forecast</a></span><span class="op">(</span><span class="va">train_df</span>, h <span class="op">=</span> <span class="fl">24</span><span class="op">)</span></span>
<span><span class="co">#&gt; Frequency chosen: h</span></span>
<span><span class="va">fc_finetune</span> <span class="op">&lt;-</span> <span class="fu">nixtlar</span><span class="fu">::</span><span class="fu"><a href="../reference/nixtla_client_forecast.html">nixtla_client_forecast</a></span><span class="op">(</span><span class="va">train_df</span>, h <span class="op">=</span> <span class="fl">24</span>, finetune_steps <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>  </span>
<span><span class="co">#&gt; Frequency chosen: h</span></span>
<span><span class="va">fc_finetune_depth</span> <span class="op">&lt;-</span> <span class="fu">nixtlar</span><span class="fu">::</span><span class="fu"><a href="../reference/nixtla_client_forecast.html">nixtla_client_forecast</a></span><span class="op">(</span><span class="va">train_df</span>, h <span class="op">=</span> <span class="fl">24</span>, finetune_steps <span class="op">=</span> <span class="fl">100</span>, finetune_depth <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> </span>
<span><span class="co">#&gt; Frequency chosen: h</span></span></code></pre></div>
<p>Next, we will evaluate the accuracy of the predictions using the <a href="https://en.wikipedia.org/wiki/Mean_absolute_error" class="external-link">Mean Absolute
Error</a> (MAE), a widely used metric for evaluating forecasts. Note
that we need to convert the timestamps in the test set to merge them
with the forecasts. This is because the
<code>nixtla_client_forecast</code> function returns timestamps as date
objects for plotting with the <code>nixtla_client_plot</code>
function.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_df</span><span class="op">$</span><span class="va">ds</span> <span class="op">&lt;-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd_hms.html" class="external-link">ymd_hms</a></span><span class="op">(</span><span class="va">test_df</span><span class="op">$</span><span class="va">ds</span><span class="op">)</span></span>
<span></span>
<span><span class="va">compute_mae</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">forecast</span>, <span class="va">test</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">test</span>, <span class="va">forecast</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"unique_id"</span>, <span class="st">"ds"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>abs_error <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">y</span><span class="op">-</span><span class="va">TimeGPT</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">mae</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">abs_error</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">mae</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"MAE zero-shot model: "</span>, <span class="fu">compute_mae</span><span class="op">(</span><span class="va">test_df</span>, <span class="va">fc_zeroshot</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "MAE zero-shot model: 4.35"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"MAE fine-tune model: "</span>, <span class="fu">compute_mae</span><span class="op">(</span><span class="va">test_df</span>, <span class="va">fc_finetune</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "MAE fine-tune model: 4.08"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"MAE fine-tune model with depth: "</span>, <span class="fu">compute_mae</span><span class="op">(</span><span class="va">test_df</span>, <span class="va">fc_finetune_depth</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "MAE fine-tune model with depth: 3.88"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="final-recommendations">4. Final recommendations<a class="anchor" aria-label="anchor" href="#final-recommendations"></a>
</h2>
<p>Fine-tuning can involve a trial-and-error process. We recommend
monitoring the performance of your model and adjusting the fine-tuning
parameters as needed. Keep in mind that fine-tuning may lead to longer
training times and can increase the risk of overfitting, so use it with
caution.</p>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Mariana Menchero.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
